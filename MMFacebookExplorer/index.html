<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Last deployment: 2025-01-19 @ 21:30 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM Facebook Archive Explorer</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #f8f9fa;
            --accent-color: #1e61bd;
            --accent-hover: #1851a3;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-light: 0 2px 12px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 8px 40px rgba(0, 0, 0, 0.12);
            --gradient-primary: linear-gradient(135deg, #1e61bd 0%, #2e7dd1 100%);
            --gradient-secondary: linear-gradient(135deg, #1e61bd 0%, #3e8ae5 100%);
            --titlebar-bg: #353a3f;
            --titlebar-text: #e4e6ea;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
            margin: 0;
            padding-top: 75px;
        }

        .titlebar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 75px;
            background: var(--titlebar-bg);
            border-bottom: 1px solid #4a4b4c;
            display: flex;
            align-items: center;
            padding: 0;
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }

        .titlebar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            padding-right: 20px;
        }

        .titlebar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding-left: 20px;
        }

        .titlebar-center {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 800px;
            margin: 0 2rem;
        }

        .help-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--titlebar-text);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .help-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .titlebar-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .titlebar-search input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--titlebar-text);
            transition: all 0.3s ease;
        }

        .titlebar-search input::placeholder {
            color: rgba(228, 230, 234, 0.7);
        }

        .titlebar-search input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(30, 97, 189, 0.2);
        }

        .titlebar-search i {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(228, 230, 234, 0.7);
            font-size: 0.8rem;
        }

        .titlebar-filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .titlebar-filter-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--titlebar-text);
            white-space: nowrap;
        }

        .titlebar-filter-btn:hover, .titlebar-filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -2rem -2rem 1.5rem -2rem;
            padding: 1.5rem 2rem;
            background: var(--gradient-primary);
            border-radius: 16px 16px 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .modal-body {
            line-height: 1.6;
        }

        .modal-body h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1.5rem 0 0.5rem 0;
            color: var(--text-primary);
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body p {
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        .modal-body a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .modal-body a:hover {
            text-decoration: underline;
        }

        .copyright {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .made-with {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .see-all-button {
            width: 100%;
            padding: 0.75rem;
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            border-top: none;
            color: var(--accent-color);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .see-all-button:hover {
            background: #e9ecef;
            color: var(--accent-hover);
        }

        .single-post-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            backdrop-filter: blur(4px);
        }

        .single-post-view.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .single-post-container {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            animation: modalSlideIn 0.3s ease-out;
        }

        .single-post-header {
            position: sticky;
            top: 0;
            background: var(--secondary-color);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .single-post-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .single-post-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .single-post-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        .single-post-content {
            padding: 0;
        }

        .single-post-content .post-card {
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
        }

        .single-post-content .comments-list {
            display: block !important;
            max-height: none;
        }

        .single-post-content .comments-header {
            display: none;
        }

        .titlebar-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .titlebar h1 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--titlebar-text);
            margin: 0;
            transition: color 0.3s ease;
        }

        .titlebar h1:hover {
            color: var(--accent-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--secondary-color);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .posts-container {
            column-count: auto;
            column-width: 400px;
            column-gap: 1.5rem;
            max-width: 100%;
        }

        .post-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            break-inside: avoid;
            margin-bottom: 1.5rem;
            width: 100%;
            display: inline-block;
        }

        .post-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .post-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .post-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            overflow: hidden;
        }

        .post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .post-date {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .post-content {
            padding: 1rem;
        }

        .post-text {
            line-height: 1.5;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .post-attachments {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .attachment {
            border-radius: 6px;
            overflow: hidden;
        }

        .attachment img {
            width: 100%;
            height: auto;
            display: block;
            max-height: 300px;
            object-fit: contain;
        }

        .post-stats {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--secondary-color);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-item i {
            color: var(--accent-color);
        }

        .comments-section {
            border-top: 1px solid var(--border-color);
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .comment {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-avatar.generated {
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .comment-content-wrapper {
            flex: 1;
            min-width: 0;
        }

        .comment-bubble {
            background: #f0f2f5;
            border-radius: 16px;
            padding: 8px 12px;
            margin-bottom: 4px;
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        .comment-author {
            font-weight: 600;
            font-size: 0.8rem;
            color: #050505;
            margin-bottom: 2px;
        }

        .comment-content {
            font-size: 0.85rem;
            line-height: 1.33;
            color: #050505;
            word-wrap: break-word;
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 2px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .comment-replies {
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .comment.reply {
            margin-bottom: 0.25rem;
        }

        .comment.reply .comment-avatar {
            width: 28px;
            height: 28px;
            font-size: 0.7rem;
        }

        .comment.reply .comment-bubble {
            background: #e4e6ea;
        }

        .export-comment-btn {
            margin-left: 0.5rem;
            padding: 0.2rem 0.4rem;
            background: rgba(30, 97, 189, 0.1);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }

        .export-comment-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .export-all-btn {
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-all-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .export-all-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .export-button-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }

        .export-progress-tooltip {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            min-width: 300px;
            z-index: 2000;
            display: none;
        }

        .export-progress-tooltip.show {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .export-progress-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .export-progress-close {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .export-progress-close:hover {
            background: var(--secondary-color);
        }

        .export-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--secondary-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .export-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .export-progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .screenshot-render-area {
            position: fixed;
            left: -9999px;
            top: -9999px;
            width: auto;
            height: auto;
            z-index: -1;
            background: white;
        }

        .facebook-comment-export {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: white;
            padding: 16px;
            width: 500px;
            min-height: 100px;
        }

        .facebook-comment-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .facebook-comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .facebook-comment-card {
            background: #f0f2f5;
            border-radius: 16px;
            padding: 8px 12px;
            flex: 1;
            position: relative;
        }

        .facebook-comment-author {
            font-weight: 600;
            font-size: 13px;
            color: #050505;
            margin-bottom: 2px;
        }

        .facebook-comment-text {
            font-size: 14px;
            line-height: 1.33;
            color: #050505;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .facebook-comment-attachments {
            margin-top: 8px;
        }

        .facebook-comment-attachments img {
            max-width: 100%;
            border-radius: 8px;
            display: block;
        }

        .facebook-comment-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            margin-left: 40px;
        }

        .facebook-comment-action {
            color: #65676b;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            background: none;
            border: none;
        }

        .facebook-comment-action.send-message {
            color: #1877f2;
        }

        .facebook-comment-action:hover {
            text-decoration: underline;
        }

        .facebook-comment-time {
            color: #65676b;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .no-data i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .titlebar {
                padding: 0 16px;
            }

            .titlebar h1 {
                font-size: 1.2rem;
            }

            .titlebar-center {
                margin: 0 1rem;
                max-width: none;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .titlebar-search {
                min-width: 200px;
                order: 1;
                flex: 1 1 100%;
            }

            .titlebar-filters {
                order: 2;
                flex: 1 1 100%;
                justify-content: center;
                margin-top: 0.5rem;
            }

            .titlebar-filter-btn {
                font-size: 0.7rem;
                padding: 0.3rem 0.6rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .filters {
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .posts-container {
                column-count: 1;
                column-width: auto;
            }
        }

        /* App Drawer Styles */
        .app-drawer {
            position: fixed;
            top: 75px;
            left: 0;
            width: 60px;
            height: calc(100vh - 75px);
            background: var(--titlebar-bg);
            transform: translateX(-55px);
            transition: transform 0.3s ease;
            z-index: 999;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            border-right: 1px solid #4a4b4c;
        }

        .app-drawer.open {
            transform: translateX(0);
        }

        .app-drawer-toggle {
            position: absolute;
            right: -35px;
            top: 20px;
            width: 35px;
            height: 40px;
            background: var(--titlebar-bg);
            border: none;
            border-radius: 0 8px 8px 0;
            color: var(--titlebar-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-drawer-toggle:hover {
            background: #404550;
        }

        .app-drawer-content {
            padding: 1rem 0;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Header removed - no title needed */

        .app-drawer-apps {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem 0;
        }

        .app-drawer-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--titlebar-text);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            position: relative;
            opacity: 0.7;
            background: none;
            border: none;
            padding: 0;
        }

        .app-drawer-icon:hover {
            color: white;
            opacity: 1;
            transform: scale(1.1);
            text-decoration: none;
        }

        .app-drawer-icon.active {
            opacity: 1;
            color: white;
        }

        .app-drawer-icon.active::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 0 2px 2px 0;
        }

        /* Home button stays in titlebar - removed fixed positioning */

        /* Adjust main content when drawer is open */
        body.drawer-open .container {
            margin-left: 60px;
            transition: margin-left 0.3s ease;
        }

        .app-drawer-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #4a4b4c;
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1) !important;
            border-color: rgba(220, 53, 69, 0.2) !important;
        }

        .logout-btn:hover {
            background: rgba(220, 53, 69, 0.2) !important;
            border-color: rgba(220, 53, 69, 0.3) !important;
            transform: translateY(-2px);
        }

        /* Mobile Titlebar Styles */
        @media (max-width: 768px) {
            .titlebar {
                height: auto;
                min-height: 75px;
                padding: 0;
            }
            
            .titlebar-content {
                flex-direction: column;
                align-items: stretch;
                gap: 0;
                padding: 0;
            }
            
            .titlebar-left {
                padding: 12px 20px;
                justify-content: space-between;
                width: 100%;
            }
            
            .titlebar-center {
                padding: 0 20px 12px 20px;
                margin: 0;
                max-width: none;
                flex-direction: column;
                gap: 12px;
            }
            
            .titlebar-search {
                max-width: none;
            }
            
            .titlebar-search input {
                width: 100%;
            }
            
            .titlebar-filters {
                justify-content: flex-start;
            }
            
            .help-button {
                order: 1;
            }
            
            .titlebar-left h1 {
                font-size: 1.3rem;
            }
            
            #sort-select {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="titlebar">
        <div class="titlebar-content">
            <div class="titlebar-left">
                <a href="#" id="home-globe" style="cursor: pointer; text-decoration: none; margin-right: 12px;" title="Return to Welcome Screen" onclick="goToWelcomeScreen(event)">
                    <i class="fas fa-house" style="color: white; font-size: 1.2rem;"></i>
                </a>
                <div id="homeButton" style="display: flex; align-items: center; cursor: pointer;" onclick="goToMainView()">
                    <i class="bi bi-facebook" style="color: #1877F2; font-size: 2rem; margin-right: 12px;"></i>
                    <h1>MM Facebook Archive Explorer</h1>
                </div>
            </div>
            <div class="titlebar-center">
                <div class="titlebar-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="titlebarSearchInput" placeholder="Search posts by content, author, or keywords...">
                </div>
                <div class="titlebar-filters">
                    <select id="sort-select" class="titlebar-filter-btn" style="border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: var(--titlebar-text); padding: 8px 12px;">
                        <option value="all">All Posts</option>
                        <option value="high-engagement">High Engagement</option>
                        <option value="recent">Recent Posts</option>
                        <option value="popular">Popular Posts</option>
                    </select>
                </div>
            </div>
            <button class="help-button" id="helpButton">
                <i class="fas fa-question"></i>
            </button>
        </div>
    </div>

    <!-- App Drawer Sidebar -->
    <div class="app-drawer" id="appDrawer">
        <button class="app-drawer-toggle" id="drawerToggle">
            <i class="fas fa-chevron-right"></i>
        </button>
        <div class="app-drawer-content">
            <div class="app-drawer-apps">
                <a href="../../index.html" class="app-drawer-icon" title="YouTube Explorer" onclick="sessionStorage.setItem('bypassWelcome', 'true')">
                    <i class="bi bi-youtube" style="color: #ff0000;"></i>
                </a>
                <a href="../MMInstaArchive/MMArchiveExplorer/index.html" class="app-drawer-icon" title="Instagram Explorer">
                    <i class="fab fa-instagram" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
                </a>
                <a href="#" class="app-drawer-icon active" onclick="goToMainView()" title="Facebook Explorer">
                    <i class="bi bi-facebook" style="color: #1877F2;"></i>
                </a>
            </div>
            <div class="app-drawer-footer">
                <button class="logout-icon" onclick="logoutUser()" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Facebook Archive Explorer</h2>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="copyright">© 2025 Darien Bathalter</p>
                <p>For bespoke data visualization tools...</p>
                <p><a href="https://quiettools.dev" target="_blank">https://quiettools.dev</a></p>
                
                <h3>Contact information:</h3>
                <p>Email: <a href="mailto:hello@quiettools.dev">hello@quiettools.dev</a></p>
                <p>Text / Voicemail: <a href="tel:+19045726183">(904) 572-6183</a></p>
                
                <p class="made-with">Made with Ode 🌿</p>
            </div>
        </div>
    </div>

    <!-- Single Post View Modal -->
    <div class="single-post-view" id="singlePostView">
        <div class="single-post-container">
            <div class="single-post-header">
                <h3 class="single-post-title">Post Details</h3>
                <button class="single-post-close" id="closeSinglePost">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="single-post-content" id="singlePostContent">
                <!-- Single post content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Screenshot render area for exporting comments -->
    <div class="screenshot-render-area" id="screenshotRenderArea"></div>

    <!-- Export progress tooltip -->
    <div class="export-progress-tooltip" id="exportProgressTooltip">
        <div class="export-progress-header">
            <div class="export-progress-title" id="exportProgressTitle">Exporting Comments...</div>
            <button class="export-progress-close" id="exportProgressClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="export-progress-bar">
            <div class="export-progress-fill" id="exportProgressFill"></div>
        </div>
        <div class="export-progress-text" id="exportProgressText">0 / 0 exported</div>
    </div>

    <div class="container">

        <div class="export-button-container">
            <button class="export-all-btn" id="exportAllPostCommentsBtn">
                <i class="fas fa-download"></i>
                Export All Post Comments
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon"><i class="fas fa-file-alt"></i></div>
                <div class="value" id="totalPosts">-</div>
                <div class="label">Total Posts</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-comments"></i></div>
                <div class="value" id="totalComments">-</div>
                <div class="label">Total Comments</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-heart"></i></div>
                <div class="value" id="totalReactions">-</div>
                <div class="label">Total Reactions</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-share"></i></div>
                <div class="value" id="totalShares">-</div>
                <div class="label">Total Shares</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-chart-bar"></i></div>
                <div class="value" id="avgEngagement">-</div>
                <div class="label">Avg Engagement</div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fas fa-users"></i></div>
                <div class="value" id="uniqueCommenters">-</div>
                <div class="label">Unique Commenters</div>
            </div>
        </div>

        <div class="posts-container" id="postsContainer">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <p>Loading Facebook posts data...</p>
            </div>
        </div>
    </div>

    <script>
        class FacebookAnalytics {
            constructor() {
                this.posts = [];
                this.filteredPosts = [];
                this.currentFilter = 'all';
                this.searchTerm = '';
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.renderStats();
                this.renderPosts();
            }

            async loadData() {
                try {
                    // Load the manifest file that contains list of all post directories
                    const manifestResponse = await fetch('posts-manifest.json');
                    if (!manifestResponse.ok) {
                        throw new Error('Manifest file not found. Please run: node data-loader.js');
                    }
                    
                    const manifest = await manifestResponse.json();
                    const directories = manifest.directories;
                    
                    console.log(`📊 Loading ${directories.length} posts...`);
                    
                    // Load posts in batches to avoid overwhelming the browser
                    const batchSize = 10;
                    for (let i = 0; i < directories.length; i += batchSize) {
                        const batch = directories.slice(i, i + batchSize);
                        
                        const batchPromises = batch.map(async (dir) => {
                            try {
                                return await this.loadPostData(dir);
                            } catch (error) {
                                console.warn(`Failed to load data for ${dir}:`, error);
                                return null;
                            }
                        });
                        
                        const batchResults = await Promise.all(batchPromises);
                        const validPosts = batchResults.filter(post => post !== null);
                        this.posts.push(...validPosts);
                        
                        // Update UI with progress
                        this.updateLoadingProgress(this.posts.length, directories.length);
                        
                        // Small delay to prevent UI blocking
                        if (i + batchSize < directories.length) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }

                    this.posts.sort((a, b) => new Date(b.createdAt * 1000) - new Date(a.createdAt * 1000));
                    this.filteredPosts = [...this.posts];
                    
                    console.log(`✅ Successfully loaded ${this.posts.length} posts`);
                } catch (error) {
                    console.error('Failed to load data:', error);
                    this.showNoData(error.message);
                }
            }

            updateLoadingProgress(loaded, total) {
                const container = document.getElementById('postsContainer');
                const percentage = Math.round((loaded / total) * 100);
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading Facebook posts data...</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">${loaded} of ${total} posts loaded (${percentage}%)</p>
                        <div style="width: 200px; height: 4px; background: #e9ecef; border-radius: 2px; margin: 1rem auto;">
                            <div style="width: ${percentage}%; height: 100%; background: var(--accent-color); border-radius: 2px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            }

            async loadPostData(directory) {
                try {
                    const [postResponse, commentsResponse] = await Promise.all([
                        fetch(`Facebook_Posts_Archive/${directory}/post.json`),
                        fetch(`Facebook_Posts_Archive/${directory}/comments.json`)
                    ]);

                    if (!postResponse.ok || !commentsResponse.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const postData = await postResponse.json();
                    const commentsData = await commentsResponse.json();

                    return {
                        ...postData,
                        comments: commentsData,
                        directory: directory
                    };
                } catch (error) {
                    console.warn(`Failed to load ${directory}:`, error);
                    return null;
                }
            }

            setupEventListeners() {
                document.getElementById('titlebarSearchInput').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.filterPosts();
                });

                const sortSelect = document.getElementById('sort-select');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        this.currentFilter = e.target.value;
                        this.filterPosts();
                    });
                }
            }

            filterPosts() {
                let filtered = [...this.posts];

                // Apply search filter
                if (this.searchTerm) {
                    filtered = filtered.filter(post => 
                        post.content.toLowerCase().includes(this.searchTerm) ||
                        post.author.name.toLowerCase().includes(this.searchTerm) ||
                        post.comments.some(comment => 
                            comment.content.toLowerCase().includes(this.searchTerm) ||
                            comment.author.name.toLowerCase().includes(this.searchTerm)
                        )
                    );
                }

                // Apply category filter
                switch (this.currentFilter) {
                    case 'high-engagement':
                        filtered = filtered.filter(post => 
                            (post.reactionsCount + post.commentCount + post.shareCount) > 100
                        );
                        break;
                    case 'recent':
                        filtered = filtered.sort((a, b) => b.createdAt - a.createdAt);
                        break;
                    case 'popular':
                        filtered = filtered.sort((a, b) => 
                            (b.reactionsCount + b.commentCount) - (a.reactionsCount + a.commentCount)
                        ).slice(0, 20);
                        break;
                }

                this.filteredPosts = filtered;
                this.renderPosts();
            }

            renderStats() {
                const totalComments = this.posts.reduce((sum, post) => sum + post.commentCount, 0);
                const totalReactions = this.posts.reduce((sum, post) => sum + post.reactionsCount, 0);
                const totalShares = this.posts.reduce((sum, post) => sum + post.shareCount, 0);
                const avgEngagement = this.posts.length > 0 ? 
                    Math.round((totalReactions + totalComments + totalShares) / this.posts.length) : 0;
                
                const uniqueCommenters = new Set();
                this.posts.forEach(post => {
                    post.comments.forEach(comment => {
                        uniqueCommenters.add(comment.author.id);
                    });
                });

                document.getElementById('totalPosts').textContent = this.posts.length.toLocaleString();
                document.getElementById('totalComments').textContent = totalComments.toLocaleString();
                document.getElementById('totalReactions').textContent = totalReactions.toLocaleString();
                document.getElementById('totalShares').textContent = totalShares.toLocaleString();
                document.getElementById('avgEngagement').textContent = avgEngagement.toLocaleString();
                document.getElementById('uniqueCommenters').textContent = uniqueCommenters.size.toLocaleString();
            }

            renderPosts() {
                const container = document.getElementById('postsContainer');
                
                if (this.filteredPosts.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-search"></i>
                            <p>No posts found matching your criteria</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.filteredPosts.map(post => this.renderPost(post)).join('');
            }

            renderPost(post) {
                const date = new Date(post.createdAt * 1000);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const truncatedContent = post.content.length > 300 ? 
                    post.content.substring(0, 300) + '...' : post.content;

                const attachments = this.getAttachments(post);
                const medicalMediumLink = this.extractMedicalMediumLink(post.content);
                const topComments = post.comments
                    .sort((a, b) => b.reactionsCount - a.reactionsCount)
                    .slice(0, 5);

                return `
                    <div class="post-card" data-post-id="${post.post_id}">
                        <div class="post-header">
                            <div class="post-avatar"><img src="avatar.webp" alt="${post.author.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='${post.author.name.split(' ').map(n => n[0]).join('').toUpperCase()}'"></div>
                            <div class="post-meta">
                                <div class="post-author">${post.author.name}</div>
                                <div class="post-date">${formattedDate}</div>
                            </div>
                        </div>
                        <div class="post-content">
                            <div class="post-text">${this.formatText(truncatedContent, attachments.length > 0)}</div>
                            ${attachments.length > 0 ? `
                                <div class="post-attachments">
                                    ${attachments.map(att => `
                                        <div class="attachment">
                                            ${medicalMediumLink ? `<a href="${medicalMediumLink}" target="_blank" rel="noopener">` : ''}
                                            <img src="${att}" alt="Post attachment" loading="lazy" ${medicalMediumLink ? 'style="cursor: pointer;"' : ''}>
                                            ${medicalMediumLink ? '</a>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="post-stats">
                            <div class="stat-item">
                                <i class="fas fa-heart"></i>
                                <span>${post.reactionsCount.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-comment"></i>
                                <span>${post.commentCount.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-share"></i>
                                <span>${post.shareCount.toLocaleString()}</span>
                            </div>
                        </div>
                        ${post.comments.length > 0 ? `
                            <div class="comments-section">
                                <button class="see-all-button" onclick="window.facebookAnalytics.openSinglePost('${post.post_id}')">
                                    <i class="fas fa-comment"></i> See full post and comments (${post.comments.length})
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderComment(comment, postDirectory, isReply = false) {
                const date = new Date(comment.createdAt * 1000);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Get comment attachments
                const commentAttachments = this.getCommentAttachments(comment, postDirectory);
                
                // Generate avatar color and initials
                const avatarColor = this.generateAvatarColor(comment.author.name);
                const initials = this.getUserInitials(comment.author.name);

                // Render child comments if they exist
                const childComments = comment.children && comment.children.length > 0 ? 
                    comment.children.map(child => this.renderComment(child, postDirectory, true)).join('') : '';

                const missingReplies = comment.subCommentsCount > comment.children?.length;
                const missingCount = comment.subCommentsCount - (comment.children?.length || 0);

                return `
                    <div class="comment ${isReply ? 'reply' : ''}">
                        <div class="comment-avatar generated" style="background-color: ${avatarColor};">
                            ${initials}
                        </div>
                        <div class="comment-content-wrapper">
                            <div class="comment-bubble">
                                <div class="comment-author">${comment.author.name}</div>
                                <div class="comment-content">${this.formatText(comment.content)}</div>
                                ${commentAttachments.length > 0 ? `
                                    <div class="comment-attachments" style="margin-top: 0.5rem;">
                                        <div class="post-attachments">
                                            ${commentAttachments.map(att => `
                                                <div class="attachment">
                                                    <img src="${att}" alt="Comment attachment" loading="lazy" style="border-radius: 8px; max-width: 100%;">
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="comment-meta">
                                <button class="export-comment-btn" onclick="window.facebookAnalytics.exportComment('${comment.id}', '${postDirectory}')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <span>${formattedDate}</span>
                                <span><i class="fas fa-heart"></i> ${comment.reactionsCount}</span>
                                ${comment.subCommentsCount > 0 ? `<span><i class="fas fa-reply"></i> ${comment.subCommentsCount} ${comment.subCommentsCount === 1 ? 'reply' : 'replies'}</span>` : ''}
                            </div>
                            ${childComments ? `
                                <div class="comment-replies">
                                    ${childComments}
                                    ${missingReplies ? `
                                        <div style="padding: 0.5rem 0; color: var(--text-secondary); font-size: 0.75rem; font-style: italic;">
                                            ${missingCount} more ${missingCount === 1 ? 'reply' : 'replies'} not shown...
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }


            getAttachments(post) {
                const attachments = [];
                
                // Check for post attachments from JSON data
                if (post._attachments && post._attachments.length > 0) {
                    post._attachments.forEach(filename => {
                        attachments.push(`Facebook_Posts_Archive/${post.directory}/attachments/${filename}`);
                    });
                }
                
                return attachments;
            }

            getCommentAttachments(comment, postDirectory) {
                const attachments = [];
                
                // Check for comment attachments from JSON data
                if (comment.localAttachments && comment.localAttachments.length > 0) {
                    comment.localAttachments.forEach(filename => {
                        attachments.push(`Facebook_Posts_Archive/${postDirectory}/commentsAttachments/${filename}`);
                    });
                }
                
                return attachments;
            }

            formatText(text, hasAttachments = false) {
                let formattedText = text;
                
                if (hasAttachments) {
                    // Remove Facebook photo URLs when we have images
                    formattedText = formattedText.replace(/\s*with a Photo: https:\/\/www\.facebook\.com\/photo\/\?[^\s]*$/g, '');
                    formattedText = formattedText.replace(/\s*Photo: https:\/\/www\.facebook\.com\/photo\/\?[^\s]*$/g, '');
                    
                    // Remove trailing URLs that are likely related to the image content (but keep Medical Medium links)
                    formattedText = formattedText.replace(/\s*https:\/\/geni\.us\/[^\s]*$/g, '');
                }
                
                return formattedText
                    .replace(/\n/g, '<br>')
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            }

            extractMedicalMediumLink(text) {
                const match = text.match(/(https:\/\/www\.medicalmedium\.com[^\s]*)/);
                return match ? match[1] : null;
            }

            generateAvatarColor(name) {
                // Array of vibrant, distinct colors for avatars
                const colors = [
                    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                    '#1abc9c', '#34495e', '#f1c40f', '#e67e22', '#95a5a6',
                    '#8e44ad', '#2980b9', '#27ae60', '#d35400', '#7f8c8d',
                    '#c0392b', '#16a085', '#2c3e50', '#f39800', '#8e44ad',
                    '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
                    '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
                    '#10ac84', '#ee5a6f', '#c44569', '#f8b500', '#7bed9f',
                    '#70a1ff', '#5352ed', '#ff4757', '#2ed573', '#ffa502'
                ];
                
                // Create a more robust hash function
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    const char = name.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = Math.imul(hash, 0x9e3779b9);
                    hash = hash ^ (hash >>> 16);
                }
                
                // Ensure positive number and get color
                hash = Math.abs(hash);
                const colorIndex = hash % colors.length;
                return colors[colorIndex];
            }

            getUserInitials(name) {
                const nameParts = name.trim().split(' ');
                if (nameParts.length >= 2) {
                    return (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                } else if (nameParts.length === 1) {
                    return nameParts[0].substring(0, 2).toUpperCase();
                }
                return 'U';
            }

            showNoData(errorMessage = '') {
                const container = document.getElementById('postsContainer');
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Unable to load Facebook posts data</p>
                        ${errorMessage ? `<p style="color: #dc3545; font-size: 0.9rem; margin-top: 0.5rem;">${errorMessage}</p>` : ''}
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: left; max-width: 500px; font-size: 0.9rem;">
                            <strong>Setup Instructions:</strong><br>
                            1. Open terminal in this directory<br>
                            2. Run: <code style="background: #e9ecef; padding: 2px 4px; border-radius: 4px;">node data-loader.js</code><br>
                            3. Refresh this page<br><br>
                            Make sure you have Node.js installed and the Facebook_Posts_Archive folder is present.
                        </div>
                    </div>
                `;
            }

            openSinglePost(postId) {
                const post = this.posts.find(p => p.post_id === postId);
                if (!post) return;

                const singlePostView = document.getElementById('singlePostView');
                const singlePostContent = document.getElementById('singlePostContent');
                
                // Render the full post with all comments
                const fullPostHtml = this.renderFullPost(post);
                singlePostContent.innerHTML = fullPostHtml;
                
                // Show the modal
                singlePostView.classList.add('show');
                
                // Scroll to top of modal content
                setTimeout(() => {
                    const singlePostContainer = singlePostView.querySelector('.single-post-container');
                    if (singlePostContainer) {
                        singlePostContainer.scrollTop = 0;
                    }
                }, 50); // Small delay to ensure modal is fully rendered
            }

            renderFullPost(post) {
                const date = new Date(post.createdAt * 1000);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const attachments = this.getAttachments(post);
                const medicalMediumLink = this.extractMedicalMediumLink(post.content);
                const allComments = post.comments.sort((a, b) => new Date(a.createdAt * 1000) - new Date(b.createdAt * 1000));

                return `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-avatar"><img src="avatar.webp" alt="${post.author.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='${post.author.name.split(' ').map(n => n[0]).join('').toUpperCase()}'"></div>
                            <div class="post-meta">
                                <div class="post-author">${post.author.name}</div>
                                <div class="post-date">${formattedDate}</div>
                            </div>
                        </div>
                        <div class="post-content">
                            <div class="post-text">${this.formatText(post.content, attachments.length > 0)}</div>
                            ${attachments.length > 0 ? `
                                <div class="post-attachments">
                                    ${attachments.map(att => `
                                        <div class="attachment">
                                            ${medicalMediumLink ? `<a href="${medicalMediumLink}" target="_blank" rel="noopener">` : ''}
                                            <img src="${att}" alt="Post attachment" loading="lazy" ${medicalMediumLink ? 'style="cursor: pointer;"' : ''}>
                                            ${medicalMediumLink ? '</a>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="post-stats">
                            <div class="stat-item">
                                <i class="fas fa-heart"></i>
                                <span>${post.reactionsCount.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-comment"></i>
                                <span>${post.commentCount.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-share"></i>
                                <span>${post.shareCount.toLocaleString()}</span>
                            </div>
                        </div>
                        ${post.comments.length > 0 ? `
                            <div class="comments-section">
                                <div style="padding: 1rem; display: flex; justify-content: flex-end; border-bottom: 1px solid var(--border-color);">
                                    <button class="export-all-btn" onclick="window.facebookAnalytics.exportAllCommentsFromPost('${post.post_id}')">
                                        <i class="fas fa-download"></i>
                                        Export All Comments
                                    </button>
                                </div>
                                <div class="comments-list">
                                    ${allComments.map(comment => this.renderComment(comment, post.directory)).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            async exportComment(commentId, postDirectory) {
                try {
                    // Find the comment in all posts
                    let targetComment = null;
                    let targetPost = null;
                    
                    for (const post of this.posts) {
                        const comment = this.findCommentById(post.comments, commentId);
                        if (comment) {
                            targetComment = comment;
                            targetPost = post;
                            break;
                        }
                    }
                    
                    if (!targetComment) {
                        alert('Comment not found for export');
                        return;
                    }
                    
                    // Generate the Facebook-style comment
                    const screenshotRenderArea = document.getElementById('screenshotRenderArea');
                    screenshotRenderArea.innerHTML = '';
                    
                    const exportDiv = this.createFacebookCommentExport(targetComment, postDirectory);
                    screenshotRenderArea.appendChild(exportDiv);
                    
                    // Wait for images to load
                    const images = exportDiv.getElementsByTagName('img');
                    const promises = [];
                    for (let img of images) {
                        if (!img.complete) {
                            promises.push(new Promise(resolve => { 
                                img.onload = resolve; 
                                img.onerror = resolve; 
                            }));
                        }
                    }
                    await Promise.all(promises);
                    
                    // Short delay for rendering
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Temporarily make visible for screenshot
                    screenshotRenderArea.style.left = '0px';
                    screenshotRenderArea.style.top = '0px';
                    screenshotRenderArea.style.opacity = '0.01';
                    screenshotRenderArea.style.zIndex = '-1';
                    
                    // Take screenshot
                    const canvas = await html2canvas(exportDiv, {
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: null,
                        scale: 2,
                        logging: false
                    });
                    
                    // Create download link
                    const imageURL = canvas.toDataURL('image/png');
                    const sanitizedAuthor = targetComment.author.name.replace(/[^a-zA-Z0-9_]/g, '') || 'UnknownAuthor';
                    const firstThreeWords = targetComment.content.split(' ').slice(0, 3).join('_') || 'comment';
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.download = `facebook_comment_${sanitizedAuthor}_${firstThreeWords}_${timestamp}.png`;
                    downloadLink.href = imageURL;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                } catch (error) {
                    console.error('Error exporting comment:', error);
                    alert('Failed to export comment. Please try again.');
                } finally {
                    // Reset render area
                    const screenshotRenderArea = document.getElementById('screenshotRenderArea');
                    screenshotRenderArea.innerHTML = '';
                    screenshotRenderArea.style.left = '-9999px';
                    screenshotRenderArea.style.top = '-9999px';
                    screenshotRenderArea.style.opacity = '1';
                    screenshotRenderArea.style.zIndex = 'auto';
                }
            }

            findCommentById(comments, commentId) {
                for (const comment of comments) {
                    if (comment.id === commentId) {
                        return comment;
                    }
                    if (comment.children && comment.children.length > 0) {
                        const found = this.findCommentById(comment.children, commentId);
                        if (found) return found;
                    }
                }
                return null;
            }

            createFacebookCommentExport(comment, postDirectory) {
                const avatarColor = this.generateAvatarColor(comment.author.name);
                const initials = this.getUserInitials(comment.author.name);
                const commentAttachments = this.getCommentAttachments(comment, postDirectory);
                
                const date = new Date(comment.createdAt * 1000);
                const timeAgo = this.getTimeAgo(date);
                
                const exportDiv = document.createElement('div');
                exportDiv.className = 'facebook-comment-export';
                
                exportDiv.innerHTML = `
                    <div class="facebook-comment-wrapper">
                        <div class="facebook-comment-avatar" style="background-color: ${avatarColor};">
                            ${initials}
                        </div>
                        <div class="facebook-comment-card">
                            <div class="facebook-comment-author">${comment.author.name}</div>
                            <div class="facebook-comment-text">${comment.content}</div>
                            ${commentAttachments.length > 0 ? `
                                <div class="facebook-comment-attachments">
                                    ${commentAttachments.map(att => `
                                        <img src="${att}" alt="Comment attachment">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="facebook-comment-footer">
                        <button class="facebook-comment-action">Like</button>
                        <button class="facebook-comment-action">Reply</button>
                        <button class="facebook-comment-action">Hide</button>
                        <button class="facebook-comment-action send-message">Send Message</button>
                        <span class="facebook-comment-time">${timeAgo}</span>
                    </div>
                `;
                
                return exportDiv;
            }

            getTimeAgo(date) {
                const now = new Date();
                const diffInMinutes = Math.floor((now - date) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'now';
                if (diffInMinutes < 60) return `${diffInMinutes}m`;
                
                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) return `${diffInHours}h`;
                
                const diffInDays = Math.floor(diffInHours / 24);
                if (diffInDays < 7) return `${diffInDays}d`;
                
                const diffInWeeks = Math.floor(diffInDays / 7);
                return `${diffInWeeks}w`;
            }

            async exportAllCommentsFromPost(postId) {
                const post = this.posts.find(p => p.post_id === postId);
                if (!post || post.comments.length === 0) {
                    alert('No comments found for this post');
                    return;
                }

                const allComments = this.getAllCommentsFlat(post.comments);
                await this.bulkExportComments(allComments, post.directory, `Post Comments`);
            }

            async exportAllPostComments() {
                const allComments = [];
                const allDirectories = [];
                
                for (const post of this.filteredPosts) {
                    const postComments = this.getAllCommentsFlat(post.comments);
                    allComments.push(...postComments);
                    allDirectories.push(...postComments.map(() => post.directory));
                }

                if (allComments.length === 0) {
                    alert('No comments found in current posts');
                    return;
                }

                await this.bulkExportComments(allComments, allDirectories, 'All Post Comments');
            }

            getAllCommentsFlat(comments) {
                const flatComments = [];
                
                function flattenComments(commentList) {
                    for (const comment of commentList) {
                        flatComments.push(comment);
                        if (comment.children && comment.children.length > 0) {
                            flattenComments(comment.children);
                        }
                    }
                }
                
                flattenComments(comments);
                return flatComments;
            }

            async bulkExportComments(comments, directories, exportName) {
                if (comments.length === 0) return;

                const progressTooltip = document.getElementById('exportProgressTooltip');
                const progressTitle = document.getElementById('exportProgressTitle');
                const progressFill = document.getElementById('exportProgressFill');
                const progressText = document.getElementById('exportProgressText');
                const exportAllBtn = document.getElementById('exportAllPostCommentsBtn');

                // Show progress tooltip
                progressTitle.textContent = `Creating ZIP: ${exportName}...`;
                progressFill.style.width = '0%';
                progressText.textContent = `0 / ${comments.length} processed`;
                progressTooltip.classList.add('show');

                // Disable export button
                if (exportAllBtn) {
                    exportAllBtn.disabled = true;
                    exportAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating ZIP...';
                }

                let successCount = 0;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const zip = new JSZip();

                try {
                    for (let i = 0; i < comments.length; i++) {
                        const comment = comments[i];
                        const directory = Array.isArray(directories) ? directories[i] : directories;
                        
                        try {
                            // Create export div
                            const screenshotRenderArea = document.getElementById('screenshotRenderArea');
                            screenshotRenderArea.innerHTML = '';
                            
                            const exportDiv = this.createFacebookCommentExport(comment, directory);
                            screenshotRenderArea.appendChild(exportDiv);
                            
                            // Wait for images to load
                            const images = exportDiv.getElementsByTagName('img');
                            const promises = [];
                            for (let img of images) {
                                if (!img.complete) {
                                    promises.push(new Promise(resolve => { 
                                        img.onload = resolve; 
                                        img.onerror = resolve; 
                                    }));
                                }
                            }
                            await Promise.all(promises);
                            
                            // Short delay for rendering
                            await new Promise(resolve => setTimeout(resolve, 100));
                            
                            // Temporarily make visible for screenshot
                            screenshotRenderArea.style.left = '0px';
                            screenshotRenderArea.style.top = '0px';
                            screenshotRenderArea.style.opacity = '0.01';
                            screenshotRenderArea.style.zIndex = '-1';
                            
                            // Take screenshot
                            const canvas = await html2canvas(exportDiv, {
                                useCORS: true,
                                allowTaint: true,
                                backgroundColor: null,
                                scale: 2,
                                logging: false
                            });
                            
                            // Convert canvas to blob and add to ZIP
                            const imageDataURL = canvas.toDataURL('image/png');
                            const base64Data = imageDataURL.split(',')[1];
                            const sanitizedAuthor = comment.author.name.replace(/[^a-zA-Z0-9_]/g, '') || 'UnknownAuthor';
                            const commentNumber = String(i + 1).padStart(3, '0');
                            const filename = `facebook_comment_${commentNumber}_${sanitizedAuthor}.png`;
                            
                            // Add to ZIP
                            zip.file(filename, base64Data, { base64: true });
                            
                            successCount++;
                            
                            // Reset render area
                            screenshotRenderArea.innerHTML = '';
                            screenshotRenderArea.style.left = '-9999px';
                            screenshotRenderArea.style.top = '-9999px';
                            screenshotRenderArea.style.opacity = '1';
                            screenshotRenderArea.style.zIndex = 'auto';
                            
                        } catch (error) {
                            console.error(`Error exporting comment ${i + 1}:`, error);
                        }
                        
                        // Update progress
                        const progress = ((i + 1) / comments.length) * 100;
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${successCount} / ${comments.length} processed`;
                        
                        // Small delay between exports to prevent overwhelming the browser
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    // Generate and download ZIP file
                    progressTitle.textContent = `Finalizing ZIP file...`;
                    progressText.textContent = `Creating ZIP with ${successCount} images...`;
                    
                    const zipBlob = await zip.generateAsync({ 
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 6 }
                    });
                    
                    // Create download link for ZIP
                    const downloadLink = document.createElement('a');
                    downloadLink.download = `${exportName.replace(/\s+/g, '_')}_${timestamp}.zip`;
                    downloadLink.href = URL.createObjectURL(zipBlob);
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    // Clean up object URL
                    URL.revokeObjectURL(downloadLink.href);
                    
                    // Show completion message
                    progressTitle.textContent = `ZIP Export Complete!`;
                    progressText.textContent = `${successCount} comments exported in ZIP file`;
                    
                } catch (error) {
                    console.error('Bulk export error:', error);
                    progressTitle.textContent = 'Export Error';
                    progressText.textContent = `${successCount} / ${comments.length} processed before error`;
                } finally {
                    // Re-enable export button
                    if (exportAllBtn) {
                        exportAllBtn.disabled = false;
                        exportAllBtn.innerHTML = '<i class="fas fa-download"></i> Export All Post Comments';
                    }
                    
                    // Auto-hide progress after 4 seconds (longer for ZIP completion message)
                    setTimeout(() => {
                        progressTooltip.classList.remove('show');
                    }, 4000);
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.facebookAnalytics = new FacebookAnalytics();
            
            // Home button functionality
            const homeButton = document.getElementById('homeButton');
            homeButton.addEventListener('click', () => {
                // Clear search and reset filters
                document.getElementById('titlebarSearchInput').value = '';
                const sortSelect = document.getElementById('sort-select');
                if (sortSelect) sortSelect.value = 'all';
                
                // Reset the analytics instance
                window.facebookAnalytics.searchTerm = '';
                window.facebookAnalytics.currentFilter = 'all';
                window.facebookAnalytics.filterPosts();
                
                // Close any open modals
                document.getElementById('helpModal').classList.remove('show');
                document.getElementById('singlePostView').classList.remove('show');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Help Modal functionality
            const helpButton = document.getElementById('helpButton');
            const helpModal = document.getElementById('helpModal');
            const closeModal = document.getElementById('closeModal');
            
            helpButton.addEventListener('click', () => {
                helpModal.classList.add('show');
            });
            
            closeModal.addEventListener('click', () => {
                helpModal.classList.remove('show');
            });
            
            // Close help modal when clicking outside
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.classList.remove('show');
                }
            });
            
            // Single Post Modal functionality
            const singlePostView = document.getElementById('singlePostView');
            const closeSinglePost = document.getElementById('closeSinglePost');
            
            closeSinglePost.addEventListener('click', () => {
                singlePostView.classList.remove('show');
                // Reset scroll position for next time
                setTimeout(() => {
                    const singlePostContainer = singlePostView.querySelector('.single-post-container');
                    if (singlePostContainer) {
                        singlePostContainer.scrollTop = 0;
                    }
                }, 100);
            });
            
            // Close single post modal when clicking outside
            singlePostView.addEventListener('click', (e) => {
                if (e.target === singlePostView) {
                    singlePostView.classList.remove('show');
                    // Reset scroll position for next time
                    setTimeout(() => {
                        const singlePostContainer = singlePostView.querySelector('.single-post-container');
                        if (singlePostContainer) {
                            singlePostContainer.scrollTop = 0;
                        }
                    }, 100);
                }
            });
            
            // Export progress tooltip functionality
            const exportProgressTooltip = document.getElementById('exportProgressTooltip');
            const exportProgressClose = document.getElementById('exportProgressClose');
            const exportAllPostCommentsBtn = document.getElementById('exportAllPostCommentsBtn');
            
            exportProgressClose.addEventListener('click', () => {
                exportProgressTooltip.classList.remove('show');
            });
            
            exportAllPostCommentsBtn.addEventListener('click', () => {
                window.facebookAnalytics.exportAllPostComments();
            });
            
            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (helpModal.classList.contains('show')) {
                        helpModal.classList.remove('show');
                    }
                    if (singlePostView.classList.contains('show')) {
                        singlePostView.classList.remove('show');
                        // Reset scroll position for next time
                        setTimeout(() => {
                            const singlePostContainer = singlePostView.querySelector('.single-post-container');
                            if (singlePostContainer) {
                                singlePostContainer.scrollTop = 0;
                            }
                        }, 100);
                    }
                    if (exportProgressTooltip.classList.contains('show')) {
                        exportProgressTooltip.classList.remove('show');
                    }
                }
            });
        });

        // Function to go to welcome screen bypassing login
        function goToWelcomeScreen(event) {
            event.preventDefault();
            // Store a flag to bypass login screen
            sessionStorage.setItem('bypassLogin', 'true');
            // Navigate to root
            window.location.href = '../../index.html';
        }

        // Function to go to main view when logo/title is clicked
        function goToMainView() {
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Cookie helper functions
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function removeLoginCookie() {
            document.cookie = 'mmarchive_logged_in=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
        }

        // Global logout function
        function logoutUser() {
            removeLoginCookie();
            sessionStorage.clear();
            // Show login modal instead of reloading
            const passwordModal = document.getElementById('passwordModal');
            const navbar = document.querySelector('.titlebar');
            const app = document.getElementById('app');
            
            if (passwordModal) passwordModal.style.display = 'flex';
            if (navbar) navbar.style.display = 'none';
            if (app) app.style.display = 'none';
            
            // Reset password input
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) passwordInput.value = '';
        }

        // App drawer functionality
        document.addEventListener('DOMContentLoaded', function() {
            const drawerToggle = document.getElementById('drawerToggle');
            const appDrawer = document.getElementById('appDrawer');
            
            if (drawerToggle && appDrawer) {
                drawerToggle.addEventListener('click', function() {
                    const isOpen = appDrawer.classList.contains('open');
                    if (isOpen) {
                        appDrawer.classList.remove('open');
                        document.body.classList.remove('drawer-open');
                        drawerToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    } else {
                        appDrawer.classList.add('open');
                        document.body.classList.add('drawer-open');
                        drawerToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    }
                });
            }

            // Add sessionStorage flag for app drawer navigation links
            const drawerLinks = document.querySelectorAll('.app-drawer-icon[href]');
            drawerLinks.forEach(link => {
                if (link.getAttribute('href') !== '#') {
                    link.addEventListener('click', function(e) {
                        sessionStorage.setItem('bypassLogin', 'true');
                    });
                }
            });
        });
    </script>
</body>
</html><!-- GitHub Pages deployment trigger -->
